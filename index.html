<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>66일 독서 챌린지 · 매일 20페이지</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1419;
      --card: #1a2332;
      --accent: #e8b86d;
      --accent-dim: #c49a4a;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --success: #3fb950;
      --danger: #f85149;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(232, 184, 109, 0.1), transparent),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(63, 185, 80, 0.05), transparent);
    }

    .page-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .page-header h1 {
      font-family: 'Playfair Display', 'Noto Sans KR', serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: -0.02em;
    }

    .page-header .header-action {
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    .page-header .btn-logout {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-family: inherit;
      cursor: pointer;
      padding: 0.25rem 0;
    }

    .page-header .btn-logout:hover {
      color: var(--accent);
    }

    .my-info-head .btn-logout {
      flex-shrink: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .my-info-head .btn-logout:hover {
      color: var(--accent);
    }

    .layout-three {
      display: grid;
      grid-template-columns: 280px 1fr 260px;
      gap: 1.25rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 900px) {
      .layout-three {
        grid-template-columns: 1fr;
      }
    }

    .column {
      min-width: 0;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .card-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.75rem;
    }

    /* 좌측: 내 정보 */
    .my-info-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .my-info-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .user-select-wrap {
      margin-bottom: 1rem;
    }

    .user-select-wrap label {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 0.35rem;
    }

    .user-select-wrap select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text);
      font-size: 0.9rem;
      font-family: inherit;
    }

    .my-info-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .my-info-stat {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      padding: 0.65rem;
      text-align: center;
    }

    .my-info-stat .val {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
    }

    .my-info-stat .lbl {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .today-input-wrap {
      margin-bottom: 0.75rem;
    }

    .today-input-wrap input,
    .today-input-wrap textarea {
      width: 100%;
      padding: 0.7rem 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: var(--text);
      font-size: 1rem;
      margin-bottom: 0.5rem;
      font-family: inherit;
    }

    .today-input-wrap textarea {
      min-height: 72px;
      resize: vertical;
    }

    .today-input-wrap input:focus,
    .today-input-wrap textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      padding: 0.7rem 1rem;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .btn:active { transform: scale(0.98); }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--accent-dim);
      box-shadow: 0 4px 14px rgba(232, 184, 109, 0.35);
    }

    .today-status {
      font-size: 0.85rem;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    .today-status.done { color: var(--success); }
    .today-status.ongoing { color: var(--accent); }

    .mini-progress-wrap {
      height: 6px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .mini-progress-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.4s ease;
    }

    .mini-progress-fill.success { background: var(--success); }
    .mini-progress-fill.pending { background: var(--accent); }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      font-size: 0.8rem;
      width: 100%;
      margin-top: 0.75rem;
    }

    .btn-ghost:hover { color: var(--danger); }

    .hidden { display: none !important; }

    /* 중앙: 독서 기록 리스트 */
    .record-list {
      list-style: none;
      max-height: 70vh;
      overflow-y: auto;
    }

    .record-item {
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .record-item:last-child { border-bottom: none; }

    .record-item-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .record-date {
      font-size: 0.9rem;
      color: var(--text);
      min-width: 100px;
    }

    .record-pages {
      font-weight: 600;
      color: var(--accent);
    }

    .record-badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-weight: 600;
    }

    .record-badge.certified {
      background: rgba(63, 185, 80, 0.2);
      color: var(--success);
    }

    .record-badge.partial {
      background: rgba(232, 184, 109, 0.2);
      color: var(--accent);
    }

    .record-book {
      font-size: 0.85rem;
      color: var(--accent);
      margin-top: 0.25rem;
      font-weight: 500;
    }

    .record-thought {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
      line-height: 1.4;
    }

    .record-empty {
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 2rem 0;
      text-align: center;
    }

    /* 우측: 남은 기간 + 공지사항 */
    .remaining-box {
      text-align: center;
      padding: 1rem 0;
    }

    .remaining-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      line-height: 1.2;
    }

    .remaining-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .notice-list {
      list-style: none;
      margin-top: 0.5rem;
    }

    .notice-item {
      padding: 0.6rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .notice-item:last-child { border-bottom: none; }

    .notice-item .notice-date {
      font-size: 0.75rem;
      color: var(--text-muted);
      opacity: 0.8;
      margin-bottom: 0.2rem;
    }

    .notice-empty {
      font-size: 0.85rem;
      color: var(--text-muted);
      padding: 0.75rem 0;
    }

    /* 진행률 시각화 */
    .progress-viz {
      text-align: center;
    }
    .progress-viz-donut {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto 0.75rem;
    }
    .progress-viz-donut svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }
    .progress-viz-donut .donut-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.08);
      stroke-width: 8;
    }
    .progress-viz-donut .donut-fill {
      fill: none;
      stroke: var(--success);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dasharray 0.4s ease;
    }
    .progress-viz-donut .donut-center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .progress-viz-donut .donut-val {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
      line-height: 1.2;
    }
    .progress-viz-donut .donut-lbl {
      font-size: 0.65rem;
      color: var(--text-muted);
    }
    .progress-viz-bar-wrap {
      height: 8px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      overflow: hidden;
      margin: 0.5rem 0 0.75rem;
    }
    .progress-viz-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-dim), var(--accent));
      border-radius: 8px;
      transition: width 0.4s ease;
    }
    .progress-viz-dots {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      margin-top: 0.5rem;
    }
    .progress-viz-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
    }
    .progress-viz-dot.done { background: var(--success); }
    .progress-viz-dot.today { background: var(--accent); box-shadow: 0 0 0 1px var(--card); }
    .progress-viz-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }
    .progress-viz-legend span { display: inline-flex; align-items: center; gap: 0.25rem; }
    .progress-viz-legend .dot { width: 6px; height: 6px; border-radius: 50%; }
    .progress-viz-legend .dot.done { background: var(--success); }
    .progress-viz-legend .dot.today { background: var(--accent); }
    .progress-viz-legend .dot.pending { background: rgba(255, 255, 255, 0.2); }

    /* 로그인 폼 */
    .login-form-wrap {
      max-width: 320px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: var(--card);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .login-form-wrap .card-title {
      margin-bottom: 1rem;
    }

    .login-form-wrap input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: var(--text);
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    .login-form-wrap input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .login-form-wrap label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }

    .login-form-wrap .form-group { margin-bottom: 0.5rem; }

    .login-form-wrap .btn-primary { width: 100%; margin-top: 0.5rem; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="supabase-config.js"></script>
  <script src="supabase-db.js"></script>
</head>
<body>
  <header class="page-header">
    <h1>66일 독서 챌린지</h1>
  </header>

  <div id="loginFormSection" class="login-form-wrap hidden">
    <div class="card-title">로그인</div>
    <p class="login-hint" id="loginHint" style="font-size:0.8rem;color:var(--text-muted);margin-bottom:1rem;display:none"></p>
    <div class="form-group">
      <label>이름</label>
      <input type="text" id="loginId" placeholder="본인 이름 입력" autocomplete="username">
    </div>
    <div class="form-group">
      <label>비밀번호</label>
      <input type="password" id="loginPassword" placeholder="비밀번호 입력" autocomplete="current-password">
    </div>
    <button type="button" class="btn btn-primary" id="btnLogin">로그인</button>
  </div>

  <div id="mainContent" class="layout-three">
    <!-- 좌측: 내 정보 -->
    <aside class="column layout-left">
      <div class="card">
        <div class="card-title">내 정보</div>
        <div id="userSelectorWrap" class="user-select-wrap hidden">
          <label for="userSelect">참가자</label>
          <select id="userSelect"></select>
        </div>
        <div class="my-info-head">
          <span class="my-info-name" id="myInfoName">나</span>
          <button type="button" class="btn-logout" id="btnLogout">로그아웃</button>
        </div>
        <div class="my-info-stats">
          <div class="my-info-stat">
            <div class="val" id="myInfoCertDays">0</div>
            <div class="lbl" id="myInfoCertLabel">인증 일수</div>
          </div>
          <div class="my-info-stat">
            <div class="val" id="myInfoTotalPages">0</div>
            <div class="lbl">총 페이지</div>
          </div>
        </div>
        <div class="today-input-wrap">
          <div class="card-title">기록할 날짜</div>
          <input type="date" id="recordDate">
          <div class="card-title" style="margin-top:0.75rem">읽은 페이지</div>
          <input type="number" id="todayPages" placeholder="페이지 수 입력" min="0" inputmode="numeric">
          <div class="card-title" style="margin-top:0.75rem">책 제목</div>
          <input type="text" id="todayBookTitle" placeholder="읽은 책 제목 (선택)">
          <div class="card-title" style="margin-top:0.75rem">오늘의 생각</div>
          <textarea id="todayThought" placeholder="어떤 생각을 했는지 기록해 보세요 (선택)"></textarea>
          <button type="button" class="btn btn-primary" id="btnSave">기록하기</button>
        </div>
        <div class="mini-progress-wrap">
          <div class="mini-progress-fill pending" id="todayBar" style="width: 0%"></div>
        </div>
        <div class="today-status ongoing" id="todayStatus">오늘 기록을 입력하세요.</div>
        <button type="button" class="btn btn-ghost" id="btnReset">챌린지 초기화</button>
      </div>
    </aside>

    <!-- 중앙: 독서 기록 리스트 -->
    <main class="column layout-center">
      <div class="card">
        <div class="card-title">독서 기록</div>
        <ul class="record-list" id="recordList"></ul>
        <p class="record-empty hidden" id="recordEmpty">아직 기록이 없습니다.</p>
      </div>
    </main>

    <!-- 우측: 남은 기간 + 진행률 시각화 + 공지사항 -->
    <aside class="column layout-right">
      <div class="card">
        <div class="card-title">챌린지 남은 기간</div>
        <div class="remaining-box">
          <div class="remaining-value" id="remainingValue">—</div>
          <div class="remaining-label" id="remainingLabel">남은 일수</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">진행률 시각화</div>
        <div class="progress-viz">
          <div class="progress-viz-donut">
            <svg viewBox="0 0 36 36">
              <circle class="donut-bg" cx="18" cy="18" r="15" />
              <circle class="donut-fill" id="progressDonutFill" cx="18" cy="18" r="15" stroke-dasharray="0 94.25" />
            </svg>
            <div class="donut-center">
              <div class="donut-val" id="progressDonutVal">0</div>
              <div class="donut-lbl" id="progressDonutLbl">/ 66일 인증</div>
            </div>
          </div>
          <div class="progress-viz-bar-wrap">
            <div class="progress-viz-bar" id="progressVizBar" style="width: 0%"></div>
          </div>
          <div class="progress-viz-dots" id="progressVizDots"></div>
          <div class="progress-viz-legend">
            <span><i class="dot done"></i> 인증</span>
            <span><i class="dot today"></i> 오늘</span>
            <span><i class="dot pending"></i> 미인증</span>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">공지사항</div>
        <ul class="notice-list" id="noticeList"></ul>
        <p class="notice-empty hidden" id="noticeEmpty">공지사항이 없습니다.</p>
      </div>
    </aside>
  </div>

  <script>
    const USER_LOGIN_KEY = 'reading66_user_logged';

    function getTodayKey() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    function getCurrentUserId() {
      var stored = sessionStorage.getItem(USER_LOGIN_KEY) || null;
      if (window.db && window.db.useSupabase && window.db.useSupabase() && stored) {
        var uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRe.test(stored)) {
          sessionStorage.removeItem(USER_LOGIN_KEY);
          return null;
        }
      }
      return stored;
    }

    function isUserLoggedIn() {
      return getCurrentUserId() !== null;
    }

    async function getConfig() { return window.db.getConfig(); }
    async function getUsers() { return window.db.getUsers(); }
    async function getNotices() { return window.db.getNotices(); }

    async function loadData() {
      const config = await getConfig();
      const totalDays = config.totalDays || 66;
      const goalPages = config.goalPages || 20;
      const userId = getCurrentUserId();
      let data;
      if (userId) {
        data = await window.db.getReadingData(userId);
      } else {
        data = await window.db.getSingleUserReadingData();
      }
      return { data, totalDays, goalPages };
    }

    function formatDateKey(key) {
      if (!key || key.length < 10) return key;
      const y = key.slice(0, 4), m = key.slice(5, 7), d = key.slice(8, 10);
      return y + '.' + m + '.' + d;
    }

    function getDayEntry(daily, key) {
      var v = daily[key];
      if (v == null) return { pages: 0, bookTitle: '', thought: '' };
      if (typeof v === 'number') return { pages: v, bookTitle: '', thought: '' };
      return {
        pages: typeof v.pages === 'number' ? v.pages : parseInt(v.pages, 10) || 0,
        bookTitle: (v.bookTitle != null ? String(v.bookTitle) : '').trim(),
        thought: (v.thought != null ? String(v.thought) : '').trim()
      };
    }

    async function render() {
      const config = await getConfig();
      const totalDays = config.totalDays || 66;
      const goalPages = config.goalPages || 20;
      const users = await getUsers();
      const userId = getCurrentUserId();

      if (users.length > 0 && userId) {
        document.getElementById('userSelectorWrap').classList.add('hidden');
        document.getElementById('myInfoName').textContent = (users.find(u => u.id === userId) || users[0]).name;
      } else if (users.length > 0) {
        document.getElementById('userSelectorWrap').classList.add('hidden');
        document.getElementById('myInfoName').textContent = '나';
      } else {
        document.getElementById('userSelectorWrap').classList.add('hidden');
        document.getElementById('myInfoName').textContent = '나';
      }

      const { data } = await loadData();
      const todayKey = getTodayKey();
      const daily = data.daily || {};
      const startDateObj = config.startDate ? new Date(config.startDate + 'T00:00:00') : null;

      let completedDays = 0;
      if (startDateObj) {
        for (let i = 0; i < totalDays; i++) {
          const d = new Date(startDateObj);
          d.setDate(d.getDate() + i);
          const dateKey = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
          if (getDayEntry(daily, dateKey).pages >= goalPages) completedDays++;
        }
      } else {
        completedDays = Object.keys(daily).filter(function (k) { return getDayEntry(daily, k).pages >= goalPages; }).length;
      }

      const totalPages = Object.keys(daily).reduce(function (sum, k) { return sum + getDayEntry(daily, k).pages; }, 0);
      const todayEntry = getDayEntry(daily, todayKey);
      const todayPages = todayEntry.pages;

      document.getElementById('myInfoCertDays').textContent = completedDays;
      document.getElementById('myInfoCertLabel').textContent = '인증 / ' + totalDays + '일';
      document.getElementById('myInfoTotalPages').textContent = totalPages;

      var recordDateEl = document.getElementById('recordDate');
      recordDateEl.value = todayKey;
      document.getElementById('todayPages').value = todayPages > 0 ? todayPages : '';
      document.getElementById('todayBookTitle').value = todayEntry.bookTitle || '';
      document.getElementById('todayThought').value = todayEntry.thought || '';
      var selPages = todayPages;
      var todayPct = Math.min(100, Math.round((selPages / goalPages) * 100));
      var todayBar = document.getElementById('todayBar');
      todayBar.style.width = todayPct + '%';
      todayBar.classList.toggle('success', selPages >= goalPages);
      todayBar.classList.toggle('pending', selPages < goalPages);
      var todayStatus = document.getElementById('todayStatus');
      if (selPages >= goalPages) {
        todayStatus.textContent = '오늘 목표 달성! ' + selPages + '페이지';
        todayStatus.className = 'today-status done';
      } else if (selPages > 0) {
        todayStatus.textContent = selPages + ' / ' + goalPages + '페이지';
        todayStatus.className = 'today-status ongoing';
      } else {
        todayStatus.textContent = '오늘 기록을 입력하세요.';
        todayStatus.className = 'today-status ongoing';
      }

      var recordKeys = Object.keys(daily).sort().reverse();
      var recordList = document.getElementById('recordList');
      var recordEmpty = document.getElementById('recordEmpty');
      recordList.innerHTML = '';
      if (recordKeys.length === 0) {
        recordEmpty.classList.remove('hidden');
      } else {
        recordEmpty.classList.add('hidden');
        recordKeys.forEach(function (k) {
          var entry = getDayEntry(daily, k);
          var certified = entry.pages >= goalPages;
          var safeTitle = (entry.bookTitle || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          var safeThought = (entry.thought || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
          var li = document.createElement('li');
          li.className = 'record-item';
          li.innerHTML = '<div class="record-item-head"><span class="record-date">' + formatDateKey(k) + '</span><span class="record-pages">' + entry.pages + '페이지</span><span class="record-badge ' + (certified ? 'certified' : 'partial') + '">' + (certified ? '인증' : '미인증') + '</span></div>' +
            (safeTitle ? '<div class="record-book">' + safeTitle + '</div>' : '') +
            (safeThought ? '<div class="record-thought">' + safeThought + '</div>' : '');
          recordList.appendChild(li);
        });
      }

      var startDate = config.startDate ? new Date(config.startDate + 'T00:00:00') : null;
      var endDate = startDate && totalDays ? new Date(startDate) : null;
      if (endDate) endDate.setDate(endDate.getDate() + totalDays - 1);
      var today = new Date();
      today.setHours(0, 0, 0, 0);

      var remainingEl = document.getElementById('remainingValue');
      var remainingLabel = document.getElementById('remainingLabel');
      if (startDate && endDate) {
        if (today < startDate) {
          var diff = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
          remainingEl.textContent = 'D-' + diff;
          remainingLabel.textContent = '챌린지 시작 전';
        } else if (today > endDate) {
          remainingEl.textContent = '종료';
          remainingLabel.textContent = '챌린지가 끝났습니다';
        } else {
          var left = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)) + 1;
          remainingEl.textContent = left + '일';
          remainingLabel.textContent = '남음';
        }
      } else {
        remainingEl.textContent = totalDays - completedDays;
        remainingLabel.textContent = '일 남음 (목표 기준)';
      }

      var dayStatusList = [];
      if (startDateObj) {
        today.setHours(0, 0, 0, 0);
        for (var i = 0; i < totalDays; i++) {
          var d = new Date(startDateObj);
          d.setDate(d.getDate() + i);
          var dk = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
          var entry = getDayEntry(daily, dk);
          dayStatusList.push({ dayNum: i + 1, certified: entry.pages >= goalPages, isToday: d.getTime() === today.getTime() });
        }
      } else {
        for (var i = 0; i < totalDays; i++) {
          dayStatusList.push({ dayNum: i + 1, certified: i < completedDays, isToday: false });
        }
      }
      var circumference = 2 * Math.PI * 15;
      var donutOffset = totalDays > 0 ? (completedDays / totalDays) * circumference : 0;
      document.getElementById('progressDonutFill').setAttribute('stroke-dasharray', donutOffset + ' ' + circumference);
      document.getElementById('progressDonutVal').textContent = completedDays;
      document.getElementById('progressDonutLbl').textContent = '/ ' + totalDays + '일 인증';
      var pct = totalDays > 0 ? Math.min(100, Math.round((completedDays / totalDays) * 100)) : 0;
      document.getElementById('progressVizBar').style.width = pct + '%';
      var dotsEl = document.getElementById('progressVizDots');
      dotsEl.innerHTML = '';
      dayStatusList.forEach(function (s) {
        var span = document.createElement('span');
        span.className = 'progress-viz-dot';
        if (s.certified) span.classList.add('done');
        else if (s.isToday) span.classList.add('today');
        dotsEl.appendChild(span);
      });

      var notices = await getNotices();
      var noticeList = document.getElementById('noticeList');
      var noticeEmpty = document.getElementById('noticeEmpty');
      noticeList.innerHTML = '';
      if (notices.length === 0) {
        noticeEmpty.classList.remove('hidden');
      } else {
        noticeEmpty.classList.add('hidden');
        notices.forEach(function (n) {
          var li = document.createElement('li');
          li.className = 'notice-item';
          var dateStr = n.createdAt ? formatDateKey(n.createdAt.slice(0, 10)) : '';
          var raw = n.text || n.content || '';
          var safe = raw.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
          li.innerHTML = (dateStr ? '<div class="notice-date">' + dateStr + '</div>' : '') + '<div>' + safe + '</div>';
          noticeList.appendChild(li);
        });
      }
      window._lastDaily = daily;
      window._lastConfig = config;
    }

    async function showLoginForm() {
      var users = await getUsers();
      document.getElementById('loginId').value = '';
      document.getElementById('loginPassword').value = '';
      var hint = document.getElementById('loginHint');
      if (users.length === 0) {
        hint.textContent = '등록된 참가자가 없습니다. 관리자에게 문의하세요.';
        hint.style.display = 'block';
      } else {
        hint.textContent = '';
        hint.style.display = 'none';
      }
      document.getElementById('loginFormSection').classList.remove('hidden');
      document.getElementById('mainContent').classList.add('hidden');
    }

    function showMainContent() {
      document.getElementById('loginFormSection').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    }

    async function updateView() {
      if (!getCurrentUserId()) {
        await showLoginForm();
      } else {
        showMainContent();
        await render();
      }
    }

    document.getElementById('btnLogin').addEventListener('click', async function () {
      var id = (document.getElementById('loginId').value || '').trim();
      var password = (document.getElementById('loginPassword').value || '').trim();
      var users = await getUsers();
      if (users.length === 0) {
        alert('등록된 참가자가 없습니다.');
        return;
      }
      var user = users.find(function (u) { return u.name === id; });
      if (!user) {
        alert('등록된 이름이 아닙니다. 관리자에게 문의하세요.');
        return;
      }
      var expected = (user.password !== undefined && user.password !== null) ? user.password : '';
      if (expected !== password) {
        alert('비밀번호가 일치하지 않습니다.');
        return;
      }
      sessionStorage.setItem(USER_LOGIN_KEY, user.id);
      showMainContent();
      await render();
    });

    document.getElementById('loginId').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') document.getElementById('loginPassword').focus();
    });
    document.getElementById('loginPassword').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') document.getElementById('btnLogin').click();
    });

    document.getElementById('btnLogout').addEventListener('click', function () {
      sessionStorage.removeItem(USER_LOGIN_KEY);
      sessionStorage.removeItem('reading66_admin_logged');
      showLoginForm();
    });

    document.getElementById('recordDate').addEventListener('change', function () {
      var dateKey = this.value;
      if (!dateKey) return;
      var daily = window._lastDaily || {};
      var entry = getDayEntry(daily, dateKey);
      document.getElementById('todayPages').value = entry.pages > 0 ? entry.pages : '';
      document.getElementById('todayBookTitle').value = entry.bookTitle || '';
      document.getElementById('todayThought').value = entry.thought || '';
      var goalPages = (window._lastConfig && window._lastConfig.goalPages) || 20;
      var pct = Math.min(100, Math.round((entry.pages / goalPages) * 100));
      var todayBar = document.getElementById('todayBar');
      todayBar.style.width = pct + '%';
      todayBar.classList.toggle('success', entry.pages >= goalPages);
      todayBar.classList.toggle('pending', entry.pages < goalPages);
      var todayStatus = document.getElementById('todayStatus');
      if (entry.pages >= goalPages) {
        todayStatus.textContent = entry.pages + '페이지 기록됨 (목표 달성)';
        todayStatus.className = 'today-status done';
      } else if (entry.pages > 0) {
        todayStatus.textContent = entry.pages + ' / ' + goalPages + '페이지';
        todayStatus.className = 'today-status ongoing';
      } else {
        todayStatus.textContent = '해당 날짜에 기록하세요.';
        todayStatus.className = 'today-status ongoing';
      }
    });

    document.getElementById('btnSave').addEventListener('click', async function () {
      var input = document.getElementById('todayPages');
      var val = parseInt(input.value, 10);
      if (isNaN(val) || val < 0) {
        alert('0 이상의 숫자를 입력해 주세요.');
        return;
      }
      var dateKey = (document.getElementById('recordDate').value || '').trim();
      if (!dateKey || dateKey.length < 10) dateKey = getTodayKey();
      var userId = getCurrentUserId();
      var payload = {
        pages: val,
        bookTitle: (document.getElementById('todayBookTitle').value || '').trim(),
        thought: (document.getElementById('todayThought').value || '').trim()
      };
      try {
        await window.db.saveReadingRecord(userId, dateKey, payload);
      } catch (err) {
        alert(err.message || '저장에 실패했습니다.');
        return;
      }
      await render();
    });

    document.getElementById('todayPages').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') document.getElementById('btnSave').click();
    });

    document.getElementById('btnReset').addEventListener('click', async function () {
      if (!confirm('정말 챌린지를 초기화할까요? 현재 참가자의 모든 기록이 삭제됩니다.')) return;
      var userId = getCurrentUserId();
      try {
        await window.db.deleteAllReadingData(userId);
      } catch (err) {
        alert(err.message || '초기화에 실패했습니다.');
        return;
      }
      document.getElementById('recordDate').value = getTodayKey();
      document.getElementById('todayPages').value = '';
      document.getElementById('todayBookTitle').value = '';
      document.getElementById('todayThought').value = '';
      await render();
    });

    updateView();
  </script>
</body>
</html>
